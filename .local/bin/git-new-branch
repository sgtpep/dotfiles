#!/bin/bash
set -eu

if [[ $(git status -s) ]]; then
  git stash
  stashed=1
fi

base=${2-}
[[ $base ]] || base=$(git remote show origin | grep ' HEAD branch:' | cut -d ' ' -f 5)
git checkout "$base"

git pull --stat

name=$1
git checkout -b "$name"

ref=$(git rev-parse --abbrev-ref HEAD)
git push -u origin "$ref"

[[ ! ${stashed-} ]] || git stash pop
