#!/bin/bash
set -eu
command=(sudo wpa_cli -i wlan0)
if [[ $@ ]]; then
  local path=/etc/wpa_supplicant/wpa_supplicant.conf
  if [[ $# == 2 ]]; then
    wpa_passphrase "$1" "$2" | sudo tee -a "$path" > /dev/null
  else
    sudo tee -a "$path" > /dev/null << EOF
network={
  key_mgmt=NONE
  ssid="$1"
}
EOF
  fi
  "${command[@]}" reconfigure
else
  "${command[@]}" scan
  while :; do
    output=$("${command[@]}" scan_results)
    if [[ $output ]]; then
      echo "$output"
      break
    fi
  done
fi
