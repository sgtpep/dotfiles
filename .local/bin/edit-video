#!/bin/bash
set -eu

input=$1
output=${1%.*}~.${1##*.}

action=$2
if [[ $action == concat ]]; then
  arguments=("${@:3}")
  path=$XDG_RUNTIME_DIR/ffmpeg-input
  printf 'file %q\n' "$input" "${arguments[@]}" > "$path"

  ffmpeg -f concat -safe 0 -i "$path" -c copy "$output"
  rm "$path"

  for argument in "${arguments[@]}"; do
    mv "$argument" "${argument%/*}"/."${argument##*/}"
  done
elif [[ $action == cut ]]; then
  start=$3
  end=$4
  ffmpeg -i "$input" -c copy -ss "$start" ${end:+-to "$end"} "$output"
elif [[ $action == rotate ]]; then
  angle=$3
  ffmpeg -i "$input" -c copy -metadata:s:v rotate="$angle" "$output"
fi

backup=${input%/*}/.${input##*/}
mv "$input" "$backup"

mv "$output" "$input"
