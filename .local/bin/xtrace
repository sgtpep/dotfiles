#!/bin/bash
set -eu
while :; do
  if [[ ${2-} ]]; then
    command=$(printf '%q ' "${@:2}")
  else
    command=$(rlwrap -o -C "${0##*/}" -P '' -S "${1##*/}> " -b '' -g '^ ' -q '([' -s 10000 -w 0 cat)
  fi
  if [[ $command ]]; then
    bash -c "
. "\$1"
set -x
$command
" -- "$1" |& less
    [[ ! ${2-} ]] || break
  else
    echo
    break
  fi
done
