#!/bin/bash
set -eu
if [[ $(pgrep -cf " ${BASH_SOURCE[0]}$") == 1 ]]; then
  for path in /sys/class/power_supply/*/capacity; do
    [[ -f $path ]] || exit 1
  done
  while :; do
    lock=/tmp/${0##*/}
    if (($(< "$path") < 5)) && [[ $(< "${path%/*}"/status) != Charging && ! -f $lock ]]; then
      > "$lock"
      x-terminal-emulator -T battery -e bash -"$-" -c $'read -s -p \'Low battery...\'; rm "$1"' -- "$lock" || :
    fi
    sleep 3m
  done
fi
