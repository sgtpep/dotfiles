#!/bin/bash
set -eu

function download-dictionary {
  if [[ $1 == *[А-Яа-я]* ]]; then
    local direction=RE
  else
    local direction=ER
  fi
  local path=~/.stardict/dic/stardict-$direction-LingvoUniversal-2.4.2
  if [[ ! -d $path ]]; then
    mkdir -p "${path%/*}"
    wget -O - http://download.huzheng.org/lingvo/"${path##*/}".tar.bz2 | tar -jx -C "${path%/*}" || rm -fr "$path"
  fi
}

function lookup-words {
  download-dictionary "$1"
  while :; do
    local output=$(sdcv -n "$1" |& sed 's/ \w*\.wav$//' 2>&1)
    if [[ $output =~ \ совер\.\ от\ ([^$'\n']+)$ ]]; then
      set -- "${BASH_REMATCH[1]}"
    else
      break
    fi
  done
  LESS=${LESS/F}c exec less <<< $output
}

function main {
  [[ $@ ]] || set -- $(prompt-words)
  [[ ! $@ ]] || lookup-words "$*"
}

function prompt-words {
  rlwrap -io -C sdcv -P '' -S "${0##*/}> " -b '' -g '^ ' -q '([' -s 10000 -w 0 cat
}

[[ -v BASH_SOURCE[0] && ${BASH_SOURCE[0]##*/} != ${0##*/} ]] || main "$@"
