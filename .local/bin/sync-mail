#!/bin/bash
set -eu
[[ ${FLOCK-} == $0 ]] || FLOCK=$0 exec flock "$0" bash -"$-" "$0" "$@"
if ls ~/.msmtpqueue/* &> /dev/null; then
  command=/usr/share/doc/msmtp/examples/msmtpqueue/msmtp-runqueue.sh
  [[ -x $command ]] || install-packages msmtp
  "$command"
fi
set -- "${@/#/default:}"
mbsync ${CRON+-q} "${@--a}"
for path in ~/mail/*; do
  paths=("$path"/new/*)
  if [[ -f ${paths[0]} ]]; then
    echo "${path##*/}: ${#paths[@]}"
    status=1
  fi
done
exit "${status-0}"
