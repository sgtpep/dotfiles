#!/bin/bash
set -eu
local path=~/notes
if [[ -d $path ]]; then
  command=(git -C "$path")
  mapfile -t paths < <("${command[@]}" diff --name-only)
  if [[ ${paths[@]} ]]; then
    tasks=()
    for path in "${paths[@]}"; do
      [[ ! $path =~ ^(tasks($|-) ]] || tasks+=("${BASH_REMATCH[1]}")
    done
    [[ ! ${tasks[@]} ]] || scp "${tasks[@]/#/$path/}" personal:notes
    "${command[@]}" add -A
    "${command[@]}" commit -m 'Update notes'
  fi
  "${command[@]}" pull
  [[ ! ${paths[@]} ]] || "${command[@]}" push
elif ! git clone personal:repositories/notes.git "$path"; then
  rm -fr "$path"
  exit 1
fi
