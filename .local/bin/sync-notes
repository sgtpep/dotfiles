#!/bin/bash
set -eu
path=~/notes
if [[ -d $path ]]; then
  command=(git -C "$path")
  mapfile -t notes < <("${command[@]}" diff --name-only)
  if [[ ${notes[@]} ]]; then
    paths=()
    for note in "${notes[@]}"; do
      [[ ! $note =~ ^tasks($|-) ]] || paths+=("$path/$note")
    done
    [[ ! ${paths[@]} ]] || scp "${paths[@]}" personal:notes
    "${command[@]}" add -A
    "${command[@]}" commit -m 'Update notes'
  fi
  "${command[@]}" pull
  [[ ! ${notes[@]} ]] || "${command[@]}" push
elif ! git clone personal:repositories/notes.git "$path"; then
  rm -fr "$path"
  exit 1
fi
