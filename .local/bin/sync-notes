#!/bin/bash
set -eu
if [[ -d ~/notes ]]; then
  command=(git -C ~/notes)
  mapfile -t paths < <("${command[@]}" diff --name-only)
  if [[ ${paths[@]} ]]; then
    tasks=()
    for path in "${paths[@]}"; do
      [[ ! $path =~ ^(tasks(|-[[:alnum:]]+))$ ]] || tasks+=("${BASH_REMATCH[1]}")
    done
    [[ ! ${tasks[@]} ]] || scp "${tasks[@]/#/~/notes/}" personal:notes
    "${command[@]}" add -A
    "${command[@]}" commit -m 'Update notes'
  fi
  "${command[@]}" pull
  [[ ! ${paths[@]} ]] || "${command[@]}" push
elif ! git clone personal:repositories/notes.git ~/notes; then
  rm -fr ~/notes
  exit 1
fi
