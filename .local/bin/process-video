#!/bin/bash
set -eu

function convert-video {
  local input=$1

  [[ $input != *.mp4 ]] || ! ffprobe "$input" |& grep -q ' encoder ' || return 0

  local copy=${input%.*}~.mp4
  ffmpeg -y -i "$input" -vf 'scale=-2:min(ih\, 720)' "$copy"
  rm -f "$input"

  local target=${input%.*}.mp4
  mv "$copy" "$target"
}

function convert-videos {
  local path
  for path; do
    [[ ! -f $path ]] || convert-video "$path"
  done
}

function main {
  [[ $@ ]] || set -- .

  . rename-window

  install-packages ffmpeg perl-Image-ExifTool

  . process-photo

  local path
  for path; do
    [[ -d $path ]]

    local directory=${path%/}

    lowercase-extensions "$directory"/*.{3GP,AVI,MOV,MP4}

    rename-dated "$directory"/*.{3gp,avi,mov,mp4}
    rename-kids-camera "$directory"/*.mp4
    rename-nokia "$directory"/*.mp4

    convert-videos "$directory"/*.{3gp,avi,mov,mp4}
  done
}

[[ ${BASH_SOURCE[0]} != $0 ]] || main "$@"
