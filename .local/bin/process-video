#!/bin/bash
set -eu

function convert-video {
  local input=$1
  [[ $input != *.mp4 ]] || ! ffprobe "$input" |& grep -q ' encoder ' || return 0

  local output=${input%.*}~.mp4
  ffmpeg -y -i "$input" -vf 'scale=-2:min(ih\, 720)' "$output"

  rm -f "$input"
  mv "$output" "${input%.*}".mp4
}

function convert-videos {
  local path
  for path; do
    [[ ! -f $path ]] || convert-video "$path"
  done
}

function main {
  . process-photo

  [[ $@ ]] || set -- .

  local path
  for path; do
    [[ -d $path ]]
    local directory=${path%/}

    lowercase-extensions "$directory"/*.{3GP,AVI,MOV,MP4}
    rename-dated "$directory"/*.{3gp,avi,mov,mp4}
    rename-whatsapp "$directory"/*.mp4
    convert-videos "$directory"/*.{3gp,avi,mov,mp4}
  done
}

[[ -v BASH_SOURCE[0] && ${BASH_SOURCE[0]##*/} != ${0##*/} ]] || main "$@"
