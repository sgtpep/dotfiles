#!/bin/bash
set -eu

function write-file {
  local path=$1
  local temp=$path~
  cat > "$temp"
  mv "$temp" "$path"
}

path=~/.urls
while [[ -s $path ]]; do
  uniq "$path" | write-file "$path"

  length=10
  urls=$(head -n "$length" "$path")
  status=0
  errors=$(xargs -r x-www-browser <<< "$urls" 2>&1) || status=$?

  if [[ $status != 0 ]]; then
    if [[ $errors == *'OpenUrl rate limit exceeded'* ]]; then
      sleep 15
      continue
    else
      exit "$status"
    fi
  fi

  log=$path-log
  echo "$urls" >> "$log"
  tail -n 100 "$log" | write-file "$log"

  sed -i "1,${length}d" "$path"
done
