#!/bin/bash
set -eu

[[ ${FLOCKER-} == $0 ]] || FLOCKER=$0 exec flock "$0" bash -"$-" "$0" "$@"

function write-file {
  local path=$1

  local copy=$path~
  cat > "$copy"
  mv "$copy" "$path"
}

path=~/.urls
while [[ -s $path ]]; do
  limit=10
  delay=15

  uniq "$path" | write-file "$path"

  urls=$(head -n "$limit" "$path")

  xargs -r -d '\n' gio open <<< "$urls" &> /dev/null

  log=$path.log
  echo "$urls" >> "$log"
  tail -n 100 "$log" | write-file "$log"

  sed -i "1,${limit}d" "$path"

  [[ ! -s $path ]] || sleep "$delay"
done
