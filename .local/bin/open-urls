#!/bin/bash
set -eu

if [[ ${FLOCK-} != $0 ]]; then
  path=/tmp/${0##*/}
  FLOCK=$0 exec flock "$path" "$SHELL" -"$-" "$0" "$@"
fi

function write-file {
  local path=$1

  local copy=$path~
  cat > "$copy"
  mv "$copy" "$path"
}

for command in chromium chromium-freeworld xdg-open; do
  ! command -v "$command" > /dev/null || break
done

path=~/.urls
while [[ -s $path ]]; do
  limit=10
  delay=15

  uniq "$path" | write-file "$path"

  urls=$(head -n "$limit" "$path")

  args=("$command")
  [[ $command != chromium* ]] || args+=(--password-store=basic)
  [[ $command != xdg-open ]] || args=(-n 1 "${args[@]}")

  setsid xargs -r -d '\n' "${args[@]}" <<< "$urls" &> /dev/null &
  sleep 0.1

  log=$path.log
  echo "$urls" >> "$log"
  tail -n 100 "$log" | write-file "$log"

  sed -i "1,${limit}d" "$path"

  [[ ! -s $path ]] || sleep "$delay"
done
