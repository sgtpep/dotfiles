#!/usr/bin/env python3
from os.path import expanduser, join
from urllib.parse import parse_qs
from wsgiref.simple_server import make_server

def application(environ, start_response):
  name = b'content'
  path = join(expanduser('~/notes'), environ['PATH_INFO'][1:])
  if environ['REQUEST_METHOD'] == 'POST':
    content = parse_qs(environ['wsgi.input'].read(int(environ['CONTENT_LENGTH'])))[name][0].replace(b'\r', b'')
    open(path, 'wb').write(content)
    start_response('302 Found', [('Location', environ['PATH_INFO'])])
    return []
  elif environ['PATH_INFO'] == '/favicon.ico':
    start_response('404 Not Found', [])
    return []
  else:
    start_response('200 OK', [('Content-Type', 'text/html; charset=UTF-8')])
    return map(lambda item: getattr(item, 'encode', lambda: item)(), [
      '<form method="POST">',
      '<textarea name="{}" style="border: none; height: 100%; width: 100%">'.format(name.decode()),
      open(path, 'rb').read(),
      '</textarea>',
      '<button style="background: none; border: none; cursor: pointer; padding: 0.25em; position: absolute; right: 0.5em; top: 0.5em">ðŸ’¾</button>',
    ])

if __name__ == '__main__':
  with make_server('localhost', 8000, application) as httpd:
    httpd.serve_forever()
