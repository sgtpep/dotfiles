#!/bin/bash
set -eu

declare -A executables=(
  [7zr]=p7zip
  [ag]=silversearcher-ag
  [aria2c]=aria2
  [calc]=apcalc
  [convert]=imagemagick
  [cwebp]=webp
  [dbus-launch]=dbus-x11
  [devmon]=udevil
  [dig]=dnsutils
  [ebook-convert]=calibre
  [ebook-viewer]=calibre
  [firefox]=firefox-esr
  [firejail]='firejail xpra-'
  [gem]=ruby
  [notify-send]=libnotify-bin
  [pactl]=pulseaudio
  [pdftotext]=poppler-utils
  [pip3]=python3-pip
  [rclone]='fuse rclone'
  [scp]=openssh-client
  [setxkbmap]='x11-xkb-utils xkb-data'
  [slock]=suckless-tools
  [ssh-add]=openssh-client
  [ssh-agent]=openssh-client
  [ssh]=openssh-client
  [start-pulseaudio-x11]=pulseaudio
  [unrar]=unrar-free
  [xclipboard]=x11-apps
  [xev]=x11-utils
  [xmodmap]=x11-xserver-utils
  [xprop]=x11-utils
  [xrandr]=x11-xserver-utils
  [xrdb]=x11-xserver-utils
)

function install-packages {
  local packages=(${@/%*-})
  if ! packages-installed "${packages[@]}"; then
    run-command bash -"$-" -c '[[ ! $(find /var/cache/apt/pkgcache.bin -mtime +7 2>&1) ]] || sudo apt update; sudo DEBIAN_FRONTEND=noninteractive apt -y install "$@"' -- "$@"
    until packages-installed "${packages[@]}"; do
      sleep 1
    done
  fi
}

function main {
  local executable=${0##*/}
  if [[ $executable == install-packages ]]; then
    install-packages "$@"
  else
    [[ -x /usr/bin/$executable ]] || install-packages ${executables[$executable]-"$executable"}
    exec /usr/bin/"$executable" "$@"
  fi
}

function packages-installed {
  local package
  for package; do
    local paths=(/var/lib/dpkg/info/"$package"{,:*}.list)
    [[ -f ${paths[0]} || -f ${paths[1]} ]] || return 1
  done
  dpkg -s "$@" &> /dev/null
}

function run-command {
  local command=(flock /tmp/install-packages.lock execute-online "$@")
  local background_command=(bash -"$-" -c '"$@" || read -s' -- "${command[@]}")
  if [[ ! -t 1 && -v TMUX ]]; then
    tmux new-window -n installing "${background_command[@]}"
  elif [[ ! -t 1 && -v DISPLAY && -x /usr/bin/$(readlink ~/.local/bin/x-terminal-emulator) ]]; then
    x-terminal-emulator -title installing -e "${background_command[@]}"
  else
    "${command[@]}" >&2
  fi
}

[[ -v BASH_SOURCE[0] && ${BASH_SOURCE[0]##*/} != ${0##*/} ]] || main "$@"
