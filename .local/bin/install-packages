#!/bin/bash
set -eu

declare -A commands=(
  [7zr]=p7zip
  [aria2c]=aria2
  [calc]=apcalc
  [convert]=imagemagick
  [cwebp]=webp
  [dbus-launch]=dbus-x11
  [devmon]=udevil
  [dig]=dnsutils
  [ebook-convert]=calibre
  [ebook-viewer]=calibre
  [exiftool]=libimage-exiftool-perl
  [firefox]=firefox-esr
  [firejail]='firejail xpra-'
  [notify-send]=libnotify-bin
  [pactl]=pulseaudio
  [pdftotext]=poppler-utils
  [pip3]=python3-pip
  [rclone]='fuse rclone'
  [rg]=ripgrep
  [rsvg-convert]=librsvg2-bin
  [scp]=openssh-client
  [setxkbmap]='x11-xkb-utils xkb-data'
  [slock]=suckless-tools
  [ssh-add]=openssh-client
  [ssh-agent]=openssh-client
  [ssh]=openssh-client
  [start-pulseaudio-x11]=pulseaudio
  [unrar]=unrar-free
  [xclipboard]=x11-apps
  [xev]=x11-utils
  [xmodmap]=x11-xserver-utils
  [xprop]=x11-utils
  [xrandr]=x11-xserver-utils
  [xrdb]=x11-xserver-utils
)

function install-packages {
  local packages=(${@/%*-})
  if ! packages-installed "${packages[@]}"; then
    run-command bash -"$-" -c '[[ ! $(find /var/cache/apt/pkgcache.bin -mtime +7 2>&1) ]] || sudo apt update && sudo apt -y install "$@"' -- "$@"
    until packages-installed "${packages[@]}" && ! pgrep -x dpkg > /dev/null; do
      sleep 1
    done
  fi
}

function main {
  local command=${0##*/}
  if [[ $command == install-packages ]]; then
    install-packages "$@"
  else
    set -- /usr/bin/"$command" "$@"
    [[ -x $1 ]] || install-packages ${commands[$command]-"$command"}
    exec "$@"
  fi
}

function packages-installed {
  local package
  for package; do
    local paths=(/var/lib/dpkg/info/"$package"{,:*}.list)
    [[ -f ${paths[0]} || -f ${paths[1]} ]] || return 1
  done
}

function run-command {
  local command=(flock /tmp/install-packages.lock online "$@")
  local detached_command=(bash -"$-" -c '"$@" || read -s' -- "${command[@]}")
  local title=installing
  if [[ ! -t 1 && -v TMUX ]]; then
    tmux new-window -n "$title" "${detached_command[@]}"
  elif [[ ! -t 1 && -v DISPLAY && -x /usr/bin/$(readlink ~/.local/bin/x-terminal-emulator) ]]; then
    x-terminal-emulator -title "$title" -e "${detached_command[@]}"
  else
    "${command[@]}" >&2
  fi
}

[[ -v BASH_SOURCE[0] && ${BASH_SOURCE[0]##*/} != ${0##*/} ]] || main "$@"
