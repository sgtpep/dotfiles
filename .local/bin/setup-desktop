#!/bin/bash
set -eu

function clone-dotfiles {
  if [[ ! -d ~/.git ]]; then
    install-packages git
    git -C ~ init
    git -C ~ remote add origin https://"${repository%/*}"@github.com/"$repository".git
    git -C ~ fetch
    git -C ~ checkout -ft origin/master
    git -C ~ ls-files | grep -Po '.+(?=\.orig$)' | xargs -r -I {} -d '\n' cp ~/{}{.orig,}
    configure-dotfiles
  fi
}

function configure-console-font {
  local path=/etc/default/console-setup
  local checksum=$(md5sum "$path")
  sudo sed -i 's/^\(FONTFACE="\)[^"]*/\1VGA/' "$path"
  md5sum -c --status <<< $checksum || sudo setupcon --save-only
}

function configure-dotfiles {
  [[ ! -f ~/.ssh/id_rsa ]] || git -C ~ remote set-url origin git@github.com:"$repository".git
  git -C ~ config status.showUntrackedFiles no
  local path=~/LICENSE
  rm -f "$path"
  git -C ~ update-index --assume-unchanged "$path"
}

function configure-grub {
  local path=/etc/default/grub
  local checksum=$(md5sum "$path")
  local name=GRUB_TIMEOUT_STYLE
  grep -q "^$name=" "$path" || sudo tee -a "$path" > /dev/null <<< "$name=hidden"
  sudo sed -i -f - "$path" << \EOF
s/^#*\(GRUB_TERMINAL=\).*/\1console/
s/^\(GRUB_CMDLINE_LINUX_DEFAULT\)=.*/\1="quiet loglevel=3"/
s/^\(GRUB_TIMEOUT=\).*/\11/
EOF
  md5sum -c --status <<< $checksum || sudo update-grub
}

function configure-inotify {
  sudo tee /etc/sysctl.d/50-inotify.conf > /dev/null <<< 'fs.inotify.max_user_watches=524288'
}

function configure-networking {
  local paths=(/sys/class/net/wl*)
  if [[ -d ${paths[0]} ]]; then
    local path=/etc/wpa_supplicant/wpa_supplicant.conf
    if [[ ! -f $path ]]; then
      sudo tee "$path" > /dev/null << \EOF
ctrl_interface=DIR=/run/wpa_supplicant GROUP=netdev
update_config=1
EOF
      sudo chmod 600 "$path"
    fi
    local interface=${paths[0]##*/}
    ! hp-stream-product || interface=wlo1
    sudo tee /etc/network/interfaces.d/"$interface" > /dev/null << EOF
allow-hotplug $interface
iface $interface inet manual
  wpa-roam $path
iface default inet dhcp
EOF
  fi
}

function configure-nopasswd {
  declare -A commands=(
    [acpi]=/etc/acpi/default.sh
    [apt-install]='/usr/bin/apt -y install *'
    [apt-update]='/usr/bin/apt update'
    [poweroff]=/usr/sbin/poweroff
    [rfkill]=/usr/sbin/rfkill
    [sshuttle]='/usr/bin/env PYTHONPATH=/usr/lib/python3/dist-packages /usr/bin/python3 /usr/bin/sshuttle --method auto --firewall'
  )
  local name
  for name in "${!commands[@]}"; do
    sudo tee /etc/sudoers.d/"$name" > /dev/null <<< "%sudo ALL = NOPASSWD: SETENV: ${commands[$name]}"
  done
}

function configure-xorg {
  if hp-stream-product; then
    local path=/etc/X11/xorg.conf.d
    mkdir -p "$path"
    sudo ln -fs /usr/share/doc/xserver-xorg-video-intel/xorg.conf "$path"/50-intel.conf
  fi
}

function confirm-reboot {
  if [[ $TERM == linux && $XDG_VTNR == 1 ]]; then
    read -p 'Reboot? [Y/n] '
    [[ ! $REPLY =~ ^[Yy]*$ ]] || sudo reboot
  fi
}

function disable-power-key {
  virtualbox-product || sudo sed -i 's/^#*\(HandlePowerKey=\).*/\1ignore/' /etc/systemd/logind.conf
}

function enable-archive-area {
  local path=/etc/apt/sources.list.d/$1${2+-$2}.list
  if [[ ! -f $path ]]; then
    sudo tee "$path" > /dev/null <<< "deb http://deb.debian.org/debian $(release-name)${2+-$2} $1"
    sudo apt update -o APT::Get::List-Cleanup=0 -o Dir::Etc::sourcelist="$path" -o Dir::Etc::sourceparts=-
  fi
}

function enable-autologin {
  local path=/etc/systemd/system/getty@tty1.service.d
  sudo mkdir -p "$path"
  sudo tee "$path"/autologin.conf > /dev/null << EOF
[Service]
ExecStart=
ExecStart=-/usr/sbin/agetty -a $USER %I
EOF
}

function enable-fstrim {
  sudo systemctl enable fstrim.timer
}

function fix-efi {
  local path=/boot/efi/EFI
  sudo mkdir -p "$path"/boot
  sudo cp "$path"/{debian/grub,boot/boot}x64.efi
}

function hp-stream-product {
  [[ $(product-name) == 'HP Stream '* ]]
}

function install-firmware {
  if hp-stream-product; then
    enable-archive-area non-free
    install-packages firmware-iwlwifi
  fi
}

function install-packages {
  update-apt
  dpkg -s "${@%/*}" &> /dev/null || sudo apt -y install "$@"
}

function install-unattended-upgrades {
  install-packages unattended-upgrades
}

function main {
  clone-dotfiles
  setup-system
  upgrade-system
  confirm-reboot
}

function product-name {
  local path=/sys/class/dmi/id/product_name
  [[ ! -f $path ]] || echo "$(< "$path")"
}

function release-name {
  lsb_release -cs
}

repository=sgtpep/dotfiles

function schedule-syncing {
  local command=sync-cron
  sudo tee /etc/cron.d/"$command" > /dev/null << EOF
PATH=/usr/bin:/bin:/home/$USER/.local/bin
10 * * * * $USER $command
EOF
  local path=/etc/dhcp/dhclient-exit-hooks.d/$command
  sudo tee "$path" > /dev/null << EOF
#!/bin/bash
set -eu
exec sudo -u $USER env PATH=\$PATH:$HOME/.local/bin $command
EOF
  sudo chmod +x "$path"
}

function setup-acpid {
  install-packages acpid
  sudo ln -fs /lib/systemd/system/acpid.service /etc/systemd/system/multi-user.target.wants
  sudo ln -fs /usr/share/doc/acpid/examples/default /etc/acpi/events
  local path=/etc/acpi/default.sh
  sudo tee "$path" > /dev/null << \EOF
#!/bin/bash
set -eu
if [[ $1 == button/lid ]]; then
  rm -f /home/*/.ssh/ssh-*
elif [[ $1 == video/brightness* ]]; then
  paths=(/sys/class/backlight/*)
  cd "${paths[0]}"
  if [[ $1 == *down ]]; then
    expression='/ 3 * 2'
  elif [[ $1 == *up ]]; then
    expression='* 3 / 2'
  fi
  path=brightness
  echo "$(("$(< "$path")" "$expression"))" > "$path"
  [[ $(< "$path") != 0 ]] || echo 2 > "$path"
fi
EOF
  sudo chmod +x "$path"
}

function setup-cups {
  if ! virtualbox-product; then
    install-packages cups
    sudo usermod -a -G lpadmin "$USER"
    setup-printer
  fi
}

function setup-nginx {
  install-packages nginx
  local line=$'\t''add_header Cache-Control no-cache;'
  local path=/etc/nginx/sites-enabled/default
  grep -Fqx "$line" "$path" || sudo sed -i "/^server /a \\$line" "$path"
}

function setup-printer {
  if hp-stream-product; then
    local name=HP_Ink_Tank_Wireless_410_series
    if ! lpstat -p "$name" &>/dev/null; then
      local url=$(sudo lpinfo -v | grep -o -m 1 "\bdnssd://${name//_/%20}.*" || :)
      if [[ $url ]]; then
        install-packages hplip
        sudo lpadmin -m drv:///hpcups.drv/hp-ink_tank_wireless_410_series.ppd -o PageSize=A4 -p "$name" -v "$url" -E
        sudo lpadmin -d "$name"
      fi
    fi
  fi
}

function setup-system {
  configure-console-font
  configure-grub
  configure-inotify
  configure-networking
  configure-nopasswd
  configure-xorg
  disable-power-key
  enable-autologin
  enable-fstrim
  install-firmware
  install-unattended-upgrades
  schedule-syncing
  setup-acpid
  setup-cups
  setup-nginx
  setup-virtualbox
}

function setup-virtualbox {
  if virtualbox-product; then
    fix-efi
    setup-virtualbox-guest
  fi
}

function setup-virtualbox-guest {
  enable-archive-area non-free
  install-packages dkms virtualbox-guest-additions-iso
  if ! ls /opt/VBoxGuestAdditions-* &> /dev/null; then
    sudo mount -o ro /usr/share/virtualbox/VBoxGuestAdditions.iso /mnt
    sudo /mnt/VBoxLinuxAdditions.run || :
    sudo umount /mnt
  fi
  sudo usermod -a -G vboxsf "$USER"
}

function update-apt {
  [[ ! $(find /var/cache/apt/pkgcache.bin -mtime +7 2>&1) ]] || sudo apt update
}

function upgrade-system {
  local path=/var/lib/apt/upgraded
  if [[ ! -f $path ]]; then
    update-apt
    sudo APT_LISTCHANGES_FRONTEND=none DEBIAN_FRONTEND=noninteractive apt -y -o Dpkg::Options::=--force-confnew full-upgrade
    sudo apt -y autoremove --purge
    sudo touch "$path"
  fi
}

username=danil

function virtualbox-product {
  [[ $(product-name) == VirtualBox ]]
}

[[ -v BASH_SOURCE[0] && ${BASH_SOURCE[0]##*/} != ${0##*/} ]] || main "$@"
