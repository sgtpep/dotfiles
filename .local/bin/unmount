#!/bin/bash
set -eu
if [[ ${1-} == -n ]]; then
  export preserve_power=true
  shift
fi
if [[ $@ ]]; then
  for path; do
    if [[ -b $path ]]; then
      readlink -f "$path"
    else
      findmnt -n -o source "$path"
    fi
  done
else
  findmnt -ln -o source,target | grep " /media/$USER/" | sed 's/\s\+.*$//'
fi | exec xargs -r -d '\n' -n 1 bash -"$-" -c 'udisksctl unmount -b "$1" && { [[ -v preserve_power ]] || udisksctl power-off -b "$1" 2> /dev/null || :; }' --
